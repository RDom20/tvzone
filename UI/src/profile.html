<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Kezel√©s</title>
  <style>
    /* Reset √©s alap st√≠lusok a men√ºh√∂z (ez megy be a login.js √°ltal h√≠vott overlay-be) */
    .profile-popup {
      display: flex; flex-direction: column;
      background: #111; border: 1px solid #444; border-radius: 10px;
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
      width: 230px; z-index: 9999; padding: 10px 0;
      color: #ddd;
    }
    .profile-popup button {
      background:none; border:none; color:#ddd; padding:12px 0;
      font-size:18px; cursor:pointer; border-radius:6px; transition:0.2s ease;
      font-weight: bold;
    }
    .profile-popup button:hover { background:#007bff; color:#fff; transform:scale(1.05); }

    /* √Åltal√°nos overlay st√≠lusok */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 10000;
      color: #fff;
    }
    .modal-box {
      background: #1f1f1f; padding: 25px; border-radius: 12px;
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
      color: #ddd; max-width: 90%;
      position: relative;
    }
    .modal-box h2 { color: #007bff; margin-bottom: 20px; }
    .close-btn { 
      position: absolute; top: 10px; right: 10px; 
      background: none; border: none; color: #fff; font-size: 24px; cursor: pointer;
    }
    
    /* Settings/Be√°ll√≠t√°sok st√≠lus */
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 15px;
        align-items: center;
        max-width: 600px;
        margin-bottom: 20px;
    }
    .settings-grid input[type="text"], .settings-grid input[type="password"] {
        padding: 8px; border: 1px solid #444; border-radius: 5px; background: #222; color: #fff;
    }
    .settings-grid label { text-align: right; font-weight: bold; }
    #profileImagePreview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff; }
    
    /* Watchlist st√≠lus */
    .watchlist-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 15px;
        max-height: 450px;
        overflow-y: auto;
        padding: 10px;
        background: #252525;
        border-radius: 8px;
    }
    .watchlist-item {
        background: #333; border-radius: 8px; overflow: hidden; text-align: center;
        padding-bottom: 10px;
    }
    .watchlist-item img { width: 100%; height: 120px; object-fit: cover; }
    .watchlist-item h3 { font-size: 16px; margin: 5px 0; color: #bbb; }
    .watchlist-item button { background:#007bff; color:white; padding:5px 10px; border-radius:4px; font-size:16px; }

    /* Switch Profile st√≠lus */
    .profile-list-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 15px; border-bottom: 1px solid #333; cursor: pointer;
        transition: 0.2s ease;
    }
    .profile-list-item:hover { background: #333; }
    .profile-list-item.active { background: #0056b3; font-weight: bold; }
    .profile-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>

  <!-- Profil men√º v√°z (a login.js fogja bet√∂lteni √©s beilleszteni az overlay-be) -->
  <div class="profile-popup" id="profileMenu">
    <!-- Ezekre a gombokra kattintva h√≠v√≥dnak meg a lenti JS funkci√≥k -->
    <button id="btnWatchList" class="profile-item">üì∫ Saj√°t Lista</button>
    <button id="btnSettings" class="profile-item">‚öôÔ∏è Be√°ll√≠t√°sok</button>
    <button id="btnSwitch" class="profile-item">üîÑ Profilv√°lt√°s</button>
    <button id="btnLogout" class="profile-item">üö™ Kijelentkez√©s</button>
  </div>

  <script>
    // --- KONSTANS ---
    const API_BASE = 'http://localhost:3000';
    const USER_DATA_KEY = 'allUserData';
    const LOGGED_IN_KEY = 'loggedInUser';
    
    // Glob√°lis hivatkoz√°s az overlayre, amit a login.js hozott l√©tre
    const profileOverlay = document.getElementById('profileOverlay');
    
    // --- SEG√âDF√úGGV√âNYEK ---

    /**
     * Visszaadja az aktu√°lisan bejelentkezett felhaszn√°l√≥ adatait.
     */
    function getActiveUserData() {
        const loggedUsername = localStorage.getItem(LOGGED_IN_KEY);
        const allUsers = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '[]');
        return allUsers.find(u => u.username === loggedUsername) || {};
    }

    /**
     * Elmenti az aktu√°lis felhaszn√°l√≥i adatokat a localStorage-ba.
     */
    function updateActiveUserData(newProps) {
        const loggedUsername = localStorage.getItem(LOGGED_IN_KEY);
        let allUsers = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '[]');
        
        const userIndex = allUsers.findIndex(u => u.username === loggedUsername);
        
        if (userIndex !== -1) {
            allUsers[userIndex] = { ...allUsers[userIndex], ...newProps };
        } else {
            // Ha valami√©rt nincs a list√°ban, hozz√°adjuk (fallback)
            allUsers.push({ username: loggedUsername, ...newProps });
        }
        
        localStorage.setItem(USER_DATA_KEY, JSON.stringify(allUsers));
    }
    
    /** Megjegyz√©s: A profil men√º bez√°r√°s√°√©rt a login.js felel≈ës, mi csak a funkci√≥kat kezelj√ºk. */

    // --- 1. WATCHLIST FUNKCI√ìK ---

    async function showWatchlist() {
        // Ellen≈ërizz√ºk, hogy van-e m√°r nyitva Watchlist (elker√ºlve a duplik√°ci√≥t)
        if (document.getElementById('watchlistOverlay')) return; 

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.id = 'watchlistOverlay';
        
        try {
            // Ezt a GET k√©r√©st a kor√°bbi terhel√©ses teszt is h√≠vta
            const res = await fetch(`${API_BASE}/api/watchlist`);
            if (!res.ok) throw new Error('Szerver hiba a watchlist lek√©r√©skor');
            const data = await res.json();

            overlay.innerHTML = `
                <div class="modal-box" style="width: 90%; max-width: 1000px; height: 600px;">
                    <h2>üì∫ Saj√°t Lista</h2>
                    <button class="close-btn" id="closeWatchlist">‚úñ</button>
                    <div class="watchlist-grid" id="watchlistGrid">
                        ${data.length > 0 ? data.map(item => `
                            <div class="watchlist-item">
                                <img src="${item.img || 'https://placehold.co/600x400/007bff/white?text=NO+IMAGE'}" 
                                     alt="${item.title}" onerror="this.src='https://placehold.co/600x400/007bff/white?text=NO+IMAGE'">
                                <h3>${item.title}</h3>
                                <button onclick="window.location.href='${item.link}'">‚ñ∂ Play</button>
                            </div>
                        `).join('') : '<p style="text-align:center; padding-top:50px;">‚ùå A list√°d √ºres.</p>'}
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            document.getElementById('closeWatchlist').addEventListener('click', () => overlay.remove());

        } catch (err) {
            console.error('Watchlist bet√∂lt√©si hiba:', err);
            // alert('‚ùå Hiba t√∂rt√©nt a Saj√°t Lista bet√∂lt√©sekor!');
            overlay.remove();
        }
    }

    // --- 2. SETTINGS FUNKCI√ìK ---

    function showSettings() {
        if (document.getElementById('settingsOverlay')) return; 
        
        const user = getActiveUserData();
        
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.id = 'settingsOverlay';
        
        overlay.innerHTML = `
            <div class="modal-box" style="width: 90%; max-width: 500px; height: auto;">
                <h2>‚öôÔ∏è Profil Be√°ll√≠t√°sok</h2>
                <button class="close-btn" id="closeSettings">‚úñ</button>
                <form id="settingsForm">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img id="profileImagePreview" src="${user.avatarUrl || 'https://placehold.co/100x100/007bff/white?text=P'}" alt="Profilk√©p">
                        <input type="file" id="avatarUpload" accept="image/*" style="margin-top: 10px;">
                    </div>
                    
                    <div class="settings-grid">
                        <label for="settingsUsername">Felhaszn√°l√≥n√©v:</label>
                        <input type="text" id="settingsUsername" value="${user.username || ''}" disabled>
                        
                        <label for="settingsEmail">Email:</label>
                        <input type="text" id="settingsEmail" value="${user.email || ''}">

                        <label for="settingsPassword">Jelsz√≥ (√∫j):</label>
                        <input type="password" id="settingsPassword" placeholder="Hagyja √ºresen, ha nem v√°ltozik">
                    </div>
                    
                    <button type="submit" style="width: 80%;">Ment√©s</button>
                </form>
            </div>
        `;
        document.body.appendChild(overlay);

        // Esem√©nykezel≈ëk
        document.getElementById('closeSettings').addEventListener('click', () => overlay.remove());

        // K√©pfelt√∂lt√©s el≈ën√©zet (simul√°ljuk a base64 konverzi√≥t)
        const avatarUpload = document.getElementById('avatarUpload');
        const profileImagePreview = document.getElementById('profileImagePreview');
        
        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileImagePreview.src = e.target.result; // Base64 k√©p
                };
                reader.readAsDataURL(file);
            }
        });

        // ≈∞rlap ment√©se
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newEmail = document.getElementById('settingsEmail').value.trim();
            const newPassword = document.getElementById('settingsPassword').value.trim();
            const newAvatarUrl = profileImagePreview.src;

            const updatedData = { email: newEmail, avatarUrl: newAvatarUrl };
            if (newPassword) {
                updatedData.password = newPassword; 
            }

            // Ment√©s a localStorage-ba
            updateActiveUserData(updatedData);

            // Megjegyz√©s: A val√≥di API h√≠v√°s a jelsz√≥ √©s email friss√≠t√©shez itt t√∂rt√©nne
            
            overlay.remove();
            // Mivel a profil k√©p/n√©v a headerben van, friss√≠ten√ºnk kell
            window.location.reload(); 
        });
    }

    // --- 3. SWITCH PROFILE FUNKCI√ìK ---

    function showSwitchProfile() {
        if (document.getElementById('switchOverlay')) return; 

        const loggedUsername = localStorage.getItem(LOGGED_IN_KEY);
        // Csak azokat t√°roljuk, amik m√°r bejelentkeztek a rendszerbe legal√°bb egyszer
        const allUsers = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '[]'); 
        
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.id = 'switchOverlay';

        // Profil lista gener√°l√°sa
        const userListHtml = allUsers.map(user => `
            <div class="profile-list-item ${user.username === loggedUsername ? 'active' : ''}" data-username="${user.username}">
                <img src="${user.avatarUrl || 'https://placehold.co/40x40/007bff/white?text=P'}" class="profile-avatar">
                <span>${user.username}</span>
                <span style="font-size: 14px; color: ${user.username === loggedUsername ? 'white' : '#999'}">
                    ${user.username === loggedUsername ? '(Akt√≠v)' : 'V√°lt√°s'}
                </span>
            </div>
        `).join('');

        overlay.innerHTML = `
            <div class="modal-box" style="width: 90%; max-width: 400px; height: auto;">
                <h2>üîÑ Profilv√°lt√°s</h2>
                <button class="close-btn" id="closeSwitch">‚úñ</button>
                <div id="profileListContainer">
                    ${userListHtml || '<p>Nincs t√∂bb t√°rolt profil.</p>'}
                </div>
                <button id="addProfile" style="width: 100%; margin-top: 15px;">+ √öj profil hozz√°ad√°sa (Login)</button>
            </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById('closeSwitch').addEventListener('click', () => overlay.remove());

        // Profilra kattintva v√°lt√°s
        overlay.querySelectorAll('.profile-list-item').forEach(item => {
            item.addEventListener('click', () => {
                const usernameToSwitch = item.dataset.username;
                if (usernameToSwitch !== loggedUsername) {
                    localStorage.setItem(LOGGED_IN_KEY, usernameToSwitch);
                    overlay.remove();
                    window.location.reload(); 
                }
            });
        });
        
        // √öj profil hozz√°ad√°sa (√°tir√°ny√≠t√°s/modal √∫jranyit√°s)
        document.getElementById('addProfile').addEventListener('click', () => {
            // Logikailag: kijelentkez√ºnk √©s megnyitjuk a login modalt
            handleLogout(); // Kijelentkez√©s, ami √∫jrat√∂lti az oldalt
        });
    }

    // --- 4. LOGOUT FUNKCI√ì ---

    function handleLogout() {
        localStorage.removeItem(LOGGED_IN_KEY);
        // Elt√°vol√≠tjuk a profil men√ºt (ha nyitva van)
        if (profileOverlay) profileOverlay.remove();
        // Visszavisz az oldalra, amin voltam (location.reload())
        window.location.reload(); 
    }
    
    // --- Esem√©nykezel≈ëk Csatol√°sa ---
    
    // Mivel a profile.html-t a login.js t√∂lti be, a login.js feladata az esem√©nykezel≈ëk csatol√°sa.
    // Miut√°n a login.js bet√∂lti a profile.html tartalm√°t a DOM-ba, meg kell h√≠vnia a k√ºls≈ë initProfileMenu() f√ºggv√©nyt.
    // Mivel most EGY f√°jlk√©nt kezelj√ºk:
    
    document.addEventListener('DOMContentLoaded', () => {
        // A gombokat a login.js h√≠v√°sa t√∂lti be. Ezt a blokkot csak a h√≠v√°s tesztel√©s√©re haszn√°ljuk.
        
        // Ha a men√º v√°z m√°r a DOM-ban van, csatoljuk az esem√©nyeket
        if (document.getElementById('profileMenu')) {
            document.getElementById('btnWatchList').addEventListener('click', () => {
                // profileOverlay.remove(); // Bez√°rjuk a f≈ë men√ºt, ha megnyitjuk az almen√ºt
                showWatchlist();
            });
            document.getElementById('btnSettings').addEventListener('click', () => {
                // profileOverlay.remove(); 
                showSettings();
            });
            document.getElementById('btnSwitch').addEventListener('click', showSwitchProfile);
            document.getElementById('btnLogout').addEventListener('click', handleLogout);
        }
    });

  </script>
</body>
</html>