<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #141414; color: white; overflow: hidden; }

    /* --- PLAYER CONTAINER --- */
    .fullscreen-video {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      display: none; flex-direction: column; justify-content: center; align-items: center;
      z-index: 1000;
    }
    
    .fullscreen-video video { width: 100%; height: 100%; object-fit: contain; }
    
    #scaledCanvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: black; z-index: 100; pointer-events: none;
    }

    /* --- FELIRAT OVERLAY (Dinamikus stílus) --- */
    #subtitleOverlay {
      position: absolute; 
      left: 0; right: 0;
      margin: 0 auto;
      width: 85%;
      text-align: center; 
      pointer-events: none; 
      z-index: 5000; 
      line-height: 1.4;
      transition: top 0.3s ease, font-size 0.2s;
      color: white;
      text-shadow: 0 0 4px black;
    }
    
    #subtitleOverlay span.sub-text {
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(0,0,0,0.5);
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
    }

    /* --- VEZÉRLŐK --- */
    .video-controls {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      padding: 20px; display: flex; align-items: center;
      justify-content: space-between; gap: 15px;
      z-index: 6000; opacity: 1; transition: opacity 0.3s;
    }
    .video-controls:hover { opacity: 1; }

    .control-group { display: flex; align-items: center; gap: 15px; }
    .control-btn {
      background: none; border: none; color: #ddd; font-size: 20px; cursor: pointer; transition: 0.2s;
    }
    .control-btn:hover { color: white; transform: scale(1.1); }
    
    /* --- HANGERŐ CSÚSZKA (KÉK GOMB + PROGRESS FILL) --- */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
      height: 8px;
      border-radius: 2px;
      /* Kezdeti háttér (JS frissíti majd) */
      background: linear-gradient(to right, #b3b3b3 100%, rgba(255, 255, 255, 0.2) 100%);
    }

    /* Chrome, Safari, Edge, Opera - GOMB */
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #393d41; /* Kék szín */
      cursor: pointer;
      margin-top: -5px; 
      box-shadow: 0 0 6px #393d41a6;
      transition: transform 0.1s;
      position: relative;
      z-index: 2;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    /* Chrome Track */
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 10px;
      background: transparent;
      border-radius: 2px;
      border: none;
    }

    /* Firefox */
    input[type="range"]::-moz-range-thumb {
      height: 14px; width: 14px; border: none; border-radius: 50%;
      background: #393d41; cursor: pointer;
      box-shadow: 0 0 6px #393d41a6
    }
    input[type="range"]::-moz-range-track {
      width: 100%; height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }
    input[type="range"]::-moz-range-progress {
      background-color: #b3b3b3;
      height: 10px; border-radius: 2px;
    }

    /* --- PROGRESS BAR --- */
    .progress-container {
      flex-grow: 1; height: 10px; background: #ffffff4d;
      cursor: pointer; position: relative; border-radius: 2px; transition: height 0.1s;
    }
    .progress-container:hover { height: 8px; }
    .progress-bar { height: 100%; background: #332f2f; width: 0%; border-radius: 2px; }

    /* --- MENÜK --- */
    .popup-menu {
      position: absolute; bottom: 70px; background: rgba(20, 20, 20, 0.95);
      border: 1px solid #333; padding: 10px; border-radius: 4px;
      display: none; flex-direction: column; gap: 5px;
      z-index: 6001; min-width: 200px;
    }
    .res-menu { right: 20px; }
    .cc-menu { right: 70px; }

    .popup-menu button {
      background: transparent; border: none; color: #aaa; text-align: left;
      padding: 8px 12px; cursor: pointer; font-size: 14px; border-radius: 4px;
    }
    .popup-menu button:hover { background: #333; color: white; }
    .popup-menu button.active { color: white; font-weight: bold; }
    .popup-menu button.active::before { content: '✓ '; color: #e50914; }

    .menu-header {
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid #444; padding-bottom: 8px; margin-bottom: 5px;
      font-size: 13px; color: #fff; font-weight: bold;
    }
    .settings-btn-small {
      font-size: 12px; color: #e50914; cursor: pointer; background: none; border: none;
    }
    .settings-btn-small:hover { text-decoration: underline; }

    /* Settings Controls */
    .setting-row { margin-bottom: 8px; }
    .setting-label { font-size: 12px; color: #888; display: block; margin-bottom: 2px; }
    .setting-select {
      width: 100%; background: #333; color: white; border: 1px solid #444;
      padding: 4px; border-radius: 3px; font-size: 12px;
    }

    /* Speed Overlay */
    #speedOverlay {
      position: absolute; bottom: 80px; right: 20px;
      background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px;
      z-index: 4000; display: none; text-align: center;
    }
    #speedOverlay.visible { display: block; }
  </style>
</head>
<body>

  <div class="fullscreen-video" id="playerContainer">
    <video id="fullVideo" crossorigin="anonymous" playsinline>
      <source id="videoSource" src="" type="video/mp4" />
    </video>

    <canvas id="scaledCanvas"></canvas>

    <div id="subtitleOverlay"></div>

    <div class="video-controls">
      <div class="control-group">
        <button class="control-btn" id="playPause"><i class="fas fa-play"></i></button>
        <input type="range" id="volume" min="0" max="1" step="0.05" value="1" style="width: 80px;">
        <span id="currentTime" style="font-size: 12px;">0:00</span>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div class="control-group">
        <span id="remainingTime" style="font-size: 12px;">-0:00</span>
        <button class="control-btn" onclick="toggleSpeed()"><i class="fas fa-tachometer-alt"></i></button>
        <button class="control-btn" onclick="toggleCC()"><i class="fas fa-closed-captioning"></i></button>
        <button class="control-btn" onclick="toggleQuality()"><i class="fas fa-cog"></i></button>
        <button class="control-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
      </div>

      <div id="ccMenu" class="popup-menu cc-menu">
        <div id="cc-view-list">
          <div class="menu-header">
            <span>Subtitles</span>
            <button class="settings-btn-small" onclick="switchCCView('settings')"><i class="fas fa-sliders-h"></i> Settings</button>
          </div>
          <button onclick="setSubtitle('off')" id="btn-sub-off" class="active">Off</button>
          <button onclick="setSubtitle('eng')" id="btn-sub-eng">English</button>
          <button onclick="setSubtitle('hun')" id="btn-sub-hun">Hungarian</button>
        </div>

        <div id="cc-view-settings" style="display: none;">
          <div class="menu-header">
            <button class="settings-btn-small" onclick="switchCCView('list')"><i class="fas fa-arrow-left"></i> Back</button>
            <span>Appearance</span>
          </div>

          <div class="setting-row">
            <label class="setting-label">Font Size</label>
            <select class="setting-select" id="opt-size" onchange="updateSubStyle()">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
              <option value="extra">Extra Large</option>
            </select>
          </div>

          <div class="setting-row">
            <label class="setting-label">Font Family</label>
            <select class="setting-select" id="opt-font" onchange="updateSubStyle()">
              <option value="Arial, sans-serif" selected>Sans-Serif (Arial)</option>
              <option value="'Times New Roman', serif">Serif (Times)</option>
              <option value="'Courier New', monospace">Monospace</option>
              <option value="'Impact', sans-serif">Blocky (Impact)</option>
            </select>
          </div>

          <div class="setting-row">
            <label class="setting-label">Background</label>
            <select class="setting-select" id="opt-bg" onchange="updateSubStyle()">
              <option value="rgba(0,0,0,0.8)">Black (Solid)</option>
              <option value="rgba(0,0,0,0.5)" selected>Black (Semi)</option>
              <option value="transparent">Transparent</option>
              <option value="rgba(255,255,0,0.5)">Yellow Highlight</option>
            </select>
          </div>
        </div>
      </div>

      <div id="resMenu" class="popup-menu res-menu">
        <div class="menu-header">Quality</div>
        <button onclick="setResolution('1080p')">1080p (High)</button>
        <button onclick="setResolution('720p')">720p (Med)</button>
        <button onclick="setResolution('480p')">480p (Low)</button>
      </div>

      <div id="speedOverlay">
         <button class="control-btn" onclick="adjustSpeed(-0.25)">-</button>
         <span id="speedLabel" style="margin: 0 10px;">1.00x</span>
         <button class="control-btn" onclick="adjustSpeed(0.25)">+</button>
      </div>

    </div>
  </div>

<script>
  // --- Változók ---
  const fullVideo = document.getElementById('fullVideo');
  const canvas = document.getElementById('scaledCanvas');
  const ctx = canvas.getContext('2d');
  const subtitleOverlay = document.getElementById('subtitleOverlay');
  const volumeSlider = document.getElementById('volume');
  const subtitleUrls = { eng: null, hun: null };
  let animationFrameId;
  let smoothingLevel = 'high';

  // --- BETŰMÉRET KONFIGURÁCIÓ ---
  const fontSizes = {
      window: { small: '18px', medium: '24px', large: '32px', extra: '42px' },
      full:   { small: '30px', medium: '42px', large: '56px', extra: '74px' }
  };

  // --- INIT ---
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const src = getQueryParam('src');
    const srt = getQueryParam('srt');
    const srt_hu = getQueryParam('srt_hu');
    const title = getQueryParam('title');

    if (title) document.title = decodeURIComponent(title);
    if (srt) subtitleUrls.eng = decodeURIComponent(srt);
    if (srt_hu) subtitleUrls.hun = decodeURIComponent(srt_hu);

    // Hangerő szín inicializálás
    updateVolumeColor();

    if (src) {
      document.getElementById('videoSource').src = decodeURIComponent(src);
      fullVideo.load();
      document.getElementById('playerContainer').style.display = 'flex';
      
      if (subtitleUrls.eng) setTimeout(() => setSubtitle('eng'), 500);
      
      handleLayoutChange();
    }
  });

  // --- HANGERŐ SZÍNEZÉS ---
  function updateVolumeColor() {
    const val = volumeSlider.value * 100;
    volumeSlider.style.background = `linear-gradient(to right, #b3b3b3 0%, #b3b3b3 ${val}%, rgba(255,255,255,0.2) ${val}%, rgba(255,255,255,0.2) 100%)`;
  }
  
  volumeSlider.addEventListener('input', () => {
    fullVideo.volume = volumeSlider.value;
    updateVolumeColor();
  });

  // --- POZÍCIÓ ÉS MÉRET FRISSÍTÉS ---
  function handleLayoutChange() {
    const isFull = !!document.fullscreenElement;
    if (isFull) {
       subtitleOverlay.style.top = "900px"; 
    } else {
       subtitleOverlay.style.top = "450px"; 
    }
    updateSubStyle();
  }

  // --- FELIRAT STÍLUS BEÁLLÍTÁSOK ---
  function updateSubStyle() {
    const sizeKey = document.getElementById('opt-size').value; 
    const font = document.getElementById('opt-font').value;
    const bg = document.getElementById('opt-bg').value;
    
    const isFull = !!document.fullscreenElement;
    const currentSizeSet = isFull ? fontSizes.full : fontSizes.window;
    const finalFontSize = currentSizeSet[sizeKey] || '24px';

    subtitleOverlay.style.fontSize = finalFontSize;
    subtitleOverlay.style.fontFamily = font;

    const spans = subtitleOverlay.querySelectorAll('.sub-text');
    spans.forEach(span => {
      span.style.background = bg;
      if (bg === 'transparent') {
        span.style.textShadow = '0 0 4px black, 0 0 4px black';
      } else {
        span.style.textShadow = 'none';
      }
    });
    
    window.currentSubStyle = { bg: bg };
  }

  // --- FELIRAT LOGIKA ---
  function waitForTrack(lang, maxAttempts = 20) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      const interval = setInterval(() => {
        attempts++;
        const trackObj = Array.from(fullVideo.textTracks).find(t => t.language === lang || t.srclang === lang || t.label === lang);
        if (trackObj) { clearInterval(interval); resolve(trackObj); }
        else if (attempts >= maxAttempts) { clearInterval(interval); reject("Timeout"); }
      }, 100);
    });
  }

  async function setSubtitle(lang) {
    document.querySelectorAll('#cc-view-list button').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('btn-sub-' + lang);
    if(btn) btn.classList.add('active');
    
    subtitleOverlay.innerHTML = "";
    Array.from(fullVideo.textTracks).forEach(track => { track.mode = 'disabled'; track.oncuechange = null; });
    
    if (lang === 'off') return;

    let trackElement = document.querySelector(`track[srclang="${lang}"]`);
    if (!trackElement) {
      trackElement = document.createElement('track');
      trackElement.kind = 'subtitles'; trackElement.srclang = lang; trackElement.label = lang;
      trackElement.src = subtitleUrls[lang];
      fullVideo.appendChild(trackElement);
    }

    try {
      const trackObj = await waitForTrack(lang);
      trackObj.mode = 'hidden';
      
      const renderCue = () => {
        const activeCue = trackObj.activeCues[0];
        if (activeCue) {
          const bg = window.currentSubStyle ? window.currentSubStyle.bg : 'rgba(0,0,0,0.5)';
          const text = activeCue.text.replace(/\n/g, '<br>');
          subtitleOverlay.innerHTML = `<span class="sub-text" style="background:${bg}; padding: 2px 6px; border-radius: 4px;">${text}</span>`;
        } else {
          subtitleOverlay.innerHTML = "";
        }
      };

      trackObj.oncuechange = renderCue;
      renderCue(); 
      
    } catch (e) { console.error(e); }
  }

  // --- MENÜ KEZELÉS ---
  function toggleCC() { 
    const menu = document.getElementById('ccMenu');
    menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    document.getElementById('resMenu').style.display = 'none';
    document.getElementById('speedOverlay').classList.remove('visible');
    switchCCView('list');
  }

  function switchCCView(view) {
    if (view === 'settings') {
      document.getElementById('cc-view-list').style.display = 'none';
      document.getElementById('cc-view-settings').style.display = 'block';
    } else {
      document.getElementById('cc-view-settings').style.display = 'none';
      document.getElementById('cc-view-list').style.display = 'block';
    }
  }

  function toggleQuality() {
    const menu = document.getElementById('resMenu');
    menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    document.getElementById('ccMenu').style.display = 'none';
  }

  function toggleSpeed() {
    const overlay = document.getElementById('speedOverlay');
    overlay.classList.toggle('visible');
    document.getElementById('ccMenu').style.display = 'none';
    document.getElementById('resMenu').style.display = 'none';
  }

  // --- FULLSCREEN KEZELÉS ---
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.getElementById('playerContainer').requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }

  document.addEventListener('fullscreenchange', () => {
    handleLayoutChange();
  });

  // --- CANVAS RENDER ---
  function resizeCanvas() {
    canvas.width = fullVideo.videoWidth || 1280; canvas.height = fullVideo.videoHeight || 720;
    canvas.style.width = '100%'; canvas.style.height = '100%';
  }
  fullVideo.addEventListener('loadedmetadata', resizeCanvas);

  function renderFrame() {
    if (!fullVideo.paused && !fullVideo.ended) {
      let w = 1920, h = 1080;
      if (smoothingLevel === 'low') { w=854; h=480; }
      const off = document.createElement('canvas'); off.width=w; off.height=h;
      const offCtx = off.getContext('2d');
      offCtx.imageSmoothingEnabled = true;
      offCtx.drawImage(fullVideo,0,0,w,h);
      ctx.imageSmoothingEnabled = false;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(off,0,0,canvas.width,canvas.height);
    }
    animationFrameId = requestAnimationFrame(renderFrame);
  }
  fullVideo.addEventListener('play', () => { renderFrame(); document.getElementById('playPause').innerHTML = '<i class="fas fa-pause"></i>'; });
  fullVideo.addEventListener('pause', () => { cancelAnimationFrame(animationFrameId); document.getElementById('playPause').innerHTML = '<i class="fas fa-play"></i>'; });

  // --- VEZÉRLÉS ---
  document.getElementById('playPause').addEventListener('click', () => fullVideo.paused ? fullVideo.play() : fullVideo.pause());
  
  fullVideo.addEventListener('timeupdate', () => {
    const pct = (fullVideo.currentTime / fullVideo.duration) * 100;
    document.getElementById('progressBar').style.width = pct + '%';
    const m = Math.floor(fullVideo.currentTime/60), s = Math.floor(fullVideo.currentTime%60);
    document.getElementById('currentTime').innerText = `${m}:${s<10?'0'+s:s}`;
    const rem = (fullVideo.duration - fullVideo.currentTime);
    const rm = Math.floor(rem/60), rs = Math.floor(rem%60);
    document.getElementById('remainingTime').innerText = `-${rm}:${rs<10?'0'+rs:rs}`;
  });

  document.getElementById('progressContainer').addEventListener('click', e => {
    const rect = e.target.getBoundingClientRect();
    fullVideo.currentTime = ((e.clientX - rect.left) / rect.width) * fullVideo.duration;
  });

  document.getElementById('playerContainer').addEventListener('dblclick', () => fullVideo.paused ? fullVideo.play() : fullVideo.pause());

  // HOTKEYS
  document.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if(k===' ') { e.preventDefault(); fullVideo.paused ? fullVideo.play() : fullVideo.pause(); }
    if(k==='f') toggleFullscreen();
    if(k==='c') toggleCC();
    if(k==='a' || k==='arrowleft') fullVideo.currentTime -= 5;
    if(k==='d' || k==='arrowright') fullVideo.currentTime += 5;
    
    // Hangerő hotkey-nél is frissítjük a színt
    if(k==='w' || k==='arrowup') { 
        e.preventDefault();
        fullVideo.volume = Math.min(1, fullVideo.volume+0.05); 
        volumeSlider.value = fullVideo.volume; 
        updateVolumeColor();
    }
    if(k==='s' || k==='arrowdown') { 
        e.preventDefault();
        fullVideo.volume = Math.max(0, fullVideo.volume-0.05); 
        volumeSlider.value = fullVideo.volume; 
        updateVolumeColor();
    }
  });

  function adjustSpeed(val) { fullVideo.playbackRate += val; document.getElementById('speedLabel').innerText = fullVideo.playbackRate.toFixed(2)+'x'; }
  function setResolution(res) { smoothingLevel = (res === '1080p')?'high':'low'; toggleQuality(); }

// Üzenet fogadása (Play gomb a szülő ablakból)
  window.addEventListener("message", (event) => {
    if (event.data && event.data.action === 'play') {
      const video = document.getElementById('fullVideo');
      // Ha még nem megy, elindítjuk
      if (video.paused) {
        video.play().catch(e => console.error("Play error:", e));
      }
    }
    
    // Felbontás állítás (ha van)
    if (event.data && event.data.action === 'setResolution') {
        setResolution(event.data.resolution);
    }
  });
</script>
</body>
</html>