<!DOCTYPE html>
<html lang="hu">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width,initial-scale=1" />
 <title>TVZone - Details (Fixed)</title>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

 <style>
  body {
  background-color: #111;
  color: #eee;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
  }

  .player-wrapper {
  position: relative;
  width: 100%;
  max-width: 1000px;
  height: 600px;
  background: #000;
  border-radius: 10px;
  overflow: hidden;
  margin: 0 auto 20px auto;
  }

  .iframe-player { width:100%; height:100%; border:0; }

  .player-overlay-play {
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%, -50%);
  width:120px; height:120px;
  border-radius:50%;
  background: rgba(229, 9, 20, 0.95);
  display:flex; justify-content:center; align-items:center;
  font-size:48px; color:white;
  cursor:pointer; z-index:50;
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);
  transition: transform 0.2s;
  }

  .player-overlay-play:hover { transform: translate(-50%, -50%) scale(1.05); }
  .player-overlay-play.hidden { display:none; }

  .btn-ep {
  background:#222;
  color:#fff;
  border:1px solid #333;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  transition: all 0.2s;
  }

  .btn-ep:hover { background:#333; }
  .btn-ep.active { background:#e50914; transform: translateY(-2px); }

  .seasons, .eps-list {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:16px;
  }

  .content-info {
  padding: 20px;
  background: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, #1a1a1a 100%);
  border-radius: 8px;
  margin-bottom: 20px;
  }

  .reaction-btn { background:#222; border:none; color:#fff; border-radius:50%; padding:10px; margin-left:10px; }
 </style>
</head>

<body>
 <div class="container mt-3">
   <div class="player-wrapper" id="playerWrapper">
  <iframe id="playerIframe" class="iframe-player" src="" allowfullscreen allow="autoplay; picture-in-picture"></iframe>
  <div class="player-overlay-play" id="overlayPlay">‚ñ∂</div>
  </div>

   <div class="content-info">
  <div class="buttons">
   <button class="reaction-btn">üëç</button>
   <button class="reaction-btn">‚≠ê</button>
   <button class="reaction-btn">+ My List</button>
  </div>
  <div class="details">
   <h1 class="title" id="infoTitle">C√≠m</h1>
   <p class="description" id="infoDescription">Le√≠r√°s</p>
  </div>
  </div>

  <h3 class="section-title">Seasons</h3>
  <div id="seasonsList" class="seasons"></div>

  <h3 class="section-title">Episodes</h3>
  <div id="episodesContainer" class="eps-list"></div>
 </div>

 <script>

  // ---------------------------------------------------------
  // Lek√©ri az URL-b≈ël az √°tadott param√©tert (pl. title)
  // ---------------------------------------------------------
  function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
  }

  // Kilist√°zott c√≠m megjelen√≠t√©se
  const title = decodeURIComponent(getQueryParam('title') || '');
  document.getElementById('infoTitle').textContent = title;

  // ---------------------------------------------------------
  // √Åltal√°nos objektumok a film/sorozat kezel√©s√©hez
  // ---------------------------------------------------------
  let mediaType = null; 
  let mediaData = null; 
  let episodesData = null;
  let currentSeason = null;
  let currentEp = null;
  let currentEpisodeIndex = null;

  // ---------------------------------------------------------
  // API leh√≠v√°sa ‚Äî bet√∂lti a sorozat vagy film adatait
  // ---------------------------------------------------------
  async function fetchIfNeeded() {
 try {
  const resp = await fetch(`http://localhost:3000/api/series?title=${encodeURIComponent(title)}`);
  if (!resp.ok) {
  console.error("‚ùå Nem tal√°lhat√≥:", title);
  return;
  }

  const json = await resp.json();
  mediaType = json.type; 
  mediaData = json;

  // ======================
  // HA FILM
  // ======================
  if (mediaType === "movie") {
  console.log("üé¨ Film m√≥d:", json);

  // Epiz√≥d/√©vad men√º elrejt√©se film eset√©n
  document.querySelector(".section-title:nth-of-type(1)").style.display = "none";
  document.querySelector(".section-title:nth-of-type(2)").style.display = "none";
  document.getElementById("seasonsList").style.display = "none";
  document.getElementById("episodesContainer").style.display = "none";

  // Film lej√°tsz√°sa
  const movie = json.files[0];
  loadMoviePlayer(movie);

  return;
  }

  // ======================
  // HA SOROZAT
  // ======================
  if (mediaType === "series") {
  console.log("üì∫ Sorozat m√≥d:", json);

  episodesData = json.seasons;
  renderSeasons();
  }

 } catch (err) {
  console.error("Fetch error:", err);
 }
}

  // ---------------------------------------------------------
  // Megjelen√≠ti az √©vadok list√°j√°t
  // ---------------------------------------------------------
  function renderSeasons() {
  const seasonsList = document.getElementById('seasonsList');
  const episodesContainer = document.getElementById('episodesContainer');
  seasonsList.innerHTML = '';
  episodesContainer.innerHTML = '';

  if (!episodesData) {
   seasonsList.textContent = 'No seasons or episodes found.';
   return;
  }

  // √âvadok helyes sorrendbe rendez√©se
  const seasons = Object.keys(episodesData).sort((a,b) => {
   const na = parseInt(a.match(/\d+/)?.[0] || '0', 10);
   const nb = parseInt(b.match(/\d+/)?.[0] || '0', 10);
   return na - nb;
  });

  seasons.forEach((season, idx) => {
   const btn = document.createElement('button');
   btn.className = 'btn-ep';
   btn.textContent = season;
   // Kattint√°s ‚Üí √©vad megnyit√°sa
   btn.onclick = () => {
  document.querySelectorAll('#seasonsList .btn-ep').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentSeason = season;
  showEpisodes(season);
   };
   seasonsList.appendChild(btn);

   // Az els≈ë √©vad alapb√≥l akt√≠v
   if (idx === 0) {
  btn.classList.add('active');
  currentSeason = season;
  showEpisodes(season);
   }
  });
  }

  // ---------------------------------------------------------
  // Epiz√≥dok list√°z√°sa adott √©vadb√≥l
  // ---------------------------------------------------------
  function showEpisodes(seasonKey) {
  const epContainer = document.getElementById('episodesContainer');
  epContainer.innerHTML = '';

  const episodes = episodesData[seasonKey] || [];
  if (!episodes.length) {
   epContainer.textContent = 'No episodes in this season.';
   return;
  }

  alert('üì∫ Epiz√≥dok bet√∂ltve: ' + seasonKey);

  episodes.forEach((ep, i) => {
   const b = document.createElement('button');
   b.className = 'btn-ep';
   const epNum = i + 1;
   b.textContent = `Eps ${epNum}`;
   b.title = ep.name;
   // Epiz√≥d kiv√°laszt√°sa + lej√°tsz√≥ bet√∂lt√©se
   b.onclick = () => {
  document.querySelectorAll('#episodesContainer .btn-ep').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  currentEpisodeIndex = epNum;
  currentEp = ep;
  openEpisodePlayer(ep, seasonKey, i);
   };
   epContainer.appendChild(b);
  });
  }

  // ---------------------------------------------------------
  // Epiz√≥d lej√°tsz√≥ bet√∂lt√©se (sorozatokhoz)
  // ---------------------------------------------------------
  function openEpisodePlayer(ep, seasonKey, i) {
  const iframe = document.getElementById('playerIframe');
  const overlay = document.getElementById('overlayPlay');

  // √ötvonal tiszt√≠t√°sa √©s encoding
  let rawPath = decodeURIComponent(ep.path || '');
  let cleanPart = rawPath.match(/Series\/.*/i);
  if (cleanPart) {
   cleanPart = cleanPart[0].replace(/\\/g, "/"); // Backslash cser√©je
  } else {
   console.error('‚ùå Nem tal√°lhat√≥ Series/ r√©sz a pathban:', rawPath);
   return;
  }

 
  // Teljes v√©gs≈ë el√©r√©si √∫t a szerverhez
  const videoFullSrc = `http://localhost:3000/video/${encodeURIComponent(cleanPart)}`;
  
  // üî• FELIRAT URL-EK GENER√ÅL√ÅSA SOROZATOKHOZ
  // A szerver gy√∂ker√©t≈ël relat√≠v Subtitles/ mappa haszn√°lata
  const episodeTitleBase = ep.name.replace(/\.[^/.]+$/, '').trim(); 
  const subtitleFolder = `Subtitles/`;
  
  const engSubPath = `${subtitleFolder}${episodeTitleBase} Eng.srt`;
  const hunSubPath = `${subtitleFolder}${episodeTitleBase} Hun.srt`;
  
  const engSubUrl = `http://localhost:3000/video/${encodeURIComponent(engSubPath)}`;
  const hunSubUrl = `http://localhost:3000/video/${encodeURIComponent(hunSubPath)}`;

  console.log('üé¨ Bet√∂lt√∂tt forr√°s (SOROZAT):', videoFullSrc);

  const episodeTitle = ep.name?.replace(/\.[^/.]+$/, '') || `${title} - ${seasonKey} Episode ${i+1}`;

  // Bet√∂ltj√ºk az iframe-be a helyes lej√°tsz√≥t (feliratokkal kieg√©sz√≠tve)
  iframe.src = 
   `http://localhost:3000/netflix-player.html?embedded=true&src=${encodeURIComponent(videoFullSrc)}&title=${encodeURIComponent(episodeTitle)}&srt=${encodeURIComponent(engSubUrl)}&srt_hu=${encodeURIComponent(hunSubUrl)}`;

  document.getElementById('infoTitle').textContent = episodeTitle;
  document.getElementById('infoDescription').textContent = ep.name || 'No description';

  overlay.classList.remove('hidden');
  }

// ---------------------------------------------------------
// Film lej√°tsz√≥ bet√∂lt√©se (filmekhez)
// ---------------------------------------------------------
function loadMoviePlayer(movie) {
 const iframe = document.getElementById("playerIframe");
 const overlay = document.getElementById("overlayPlay");

 // 1. FIX: Decode, normaliz√°l√°s √©s √∫tvonal tiszt√≠t√°s
 let moviePath = decodeURIComponent(movie.path || "");
 moviePath = moviePath.replace(/\\/g, "/");
 const cleanPath = moviePath.replace(/^\/?video\//i, ""); 

 const cleanTitle = movie.name.replace(/\.[^/.]+$/, ""); 

 // 2. FELIRAT URL-ek gener√°l√°sa (Filmekhez)
 const subtitleFolder = 'Subtitles/'; 

 const engSubPath = `${subtitleFolder}${cleanTitle} Eng.srt`;
 const hunSubPath = `${subtitleFolder}${cleanTitle} Hun.srt`;

 // 3. Construct the full video source URL (encoded)
 const videoFullSrc =
  `http://localhost:3000/video/${encodeURIComponent(cleanPath)}`;
 
 // 4. Construct the full subtitle source URLs (encoded)
 const engSubUrl = `http://localhost:3000/video/${encodeURIComponent(engSubPath)}`;
 const hunSubUrl = `http://localhost:3000/video/${encodeURIComponent(hunSubPath)}`;

 console.log("üé¨ Film bet√∂lt√©se (FINAL FIXED):", videoFullSrc);
 console.log("üí¨ Angol felirat:", engSubUrl);
 console.log("üí¨ Magyar felirat:", hunSubUrl);


 document.getElementById("infoTitle").textContent = cleanTitle;

 // 5. Az iframe URL-j√©be beleker√ºl a vide√≥ √©s a feliratok √∫tvonala is
 iframe.src =
  `http://localhost:3000/netflix-player.html?embedded=true&src=${encodeURIComponent(videoFullSrc)}&title=${encodeURIComponent(cleanTitle)}&srt=${encodeURIComponent(engSubUrl)}&srt_hu=${encodeURIComponent(hunSubUrl)}`;

 overlay.classList.remove("hidden");
}

  // ---------------------------------------------------------
  // Overlay play gomb m≈±k√∂d√©se
  // ---------------------------------------------------------
  document.getElementById("overlayPlay").addEventListener("click", () => {
  const iframe = document.getElementById("playerIframe");

  if (mediaType === "movie") {
   console.log("‚ñ∂ Film lej√°tsz√°s");
   iframe.contentWindow.postMessage({ action: "play" }, "*");
   document.getElementById("overlayPlay").classList.add("hidden");
   return;
  }

  if (!currentEp) {
   alert("‚ö† V√°lassz epiz√≥dot!");
   return;
  }

  console.log("‚ñ∂ Epiz√≥d lej√°tsz√°s:", currentEp.name);
  iframe.contentWindow.postMessage({ action: "play" }, "*");
  document.getElementById("overlayPlay").classList.add("hidden");
  });

  // Ind√≠t√°skor azonnal megh√≠vja az API-t √©s fel√©p√≠ti az oldalt
  fetchIfNeeded();
 </script>
</body>
</html>